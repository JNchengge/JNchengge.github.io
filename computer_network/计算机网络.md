# 
# 链路层

## 基础术语：
 - 结点(nodes)
 - 链路(links)
 - 帧`(frame)`：链路层中的数据包，包含了网络层中的数据报`(datagram)`
 - 链路层负责从一个结点，通过一条链路，将数据传到物理相邻的另一个结点

## 数据链路层是非常重要的一层：
- 在网络中，无论是主机还是路由，都必须实现这一层，比如
 - 主机的五层结构：应用层、运输层、网络层、<font color=#FF0033>链路层</font>、物理层
 - 路由的三层结构：网络层、<font color=#FF0033>链路层</font>、物理层
 - 都实现了<font color=#FF0033>链路层</font>这一结构
- 在局域网中，无论是主机还是交换机，也都必须实现链路层
 - 主机的五层结构：应用层、运输层、网络层、<font color=#FF0033>链路层</font>、物理层
 - 交换机的两层结构：<font color=#FF0033>链路层</font>、物理层
 - 也都实现了<font color=#FF0033>链路层</font>这一结构

## 数据链路层的作用
- 假设有两台主机H1、H2在通信，两台主机间的数据可能经过多种不同的网络，比如：广域网、局域网、电话网
- 先看主机的数据流动，是从应用层开始，经过完整的五层协议，最后在信道上传输
- 数据到达路由器的时候，也得自底向上、自顶向下地传输
- 所以，当我们研究数据链路层的问题时，可以忽略其他的层，直接看数据在链路层上的流动
- **在只看链路层进行分析的时候，一定要注意，不同的网络，不同的结点之间，使用的有可能是不同的协议**

## 数据链路层传送的是帧
- 帧`(frame)`：链路层中的数据包，包含了网络层中的数据报`(datagram)`

## 链路层的实现
1. 实现为适配器的形式(adapter或者网卡NIC)或者在芯片上实现，往往同时包含链路层和物理层的实现
2. 适配器/NIC再接入到主机的系统主线

## 数据链路层的三个基本问题：

### 封装成帧：
- 在一段数据的前后加上首部和尾部，就构成了一个帧
- 接收端收到物理层上交的比特流后，根据首部和尾部的标记，识别帧的开始和结束
- 一个帧是链路层的数据传送单元
- 一个帧的帧长等于数据的长度加上首部和尾部的长度
- 首部和尾部的重要作用是<font color=#FF0033>帧定界（确定帧的界限）</font>
- 每一种链路层协议都规定了所能传送的帧的数据部分长度上限——最大传送单元`MTU(Maximum Transfer Unit)`

### 透明传输*：

### 差错检测：
- 在传输过程中，可能因为信号放大、噪声等问题，导致比特出错
- <font color=#FF0033>误码率</font>：传输错误的比特占所传输比特总数的比率

#### 奇偶校验：
- 若数据中有奇数个1，则奇偶校验位为1

##### 单个位奇偶校验：
- 比如：`0111000110101011|0`是有差错的

##### 二维奇偶校验：
- 检测并更正单个位的错误（例子在计算机网络_2_链路层和局域网.ppt中）
- **注意，如果一个2X2的块中四个都出现了差错，那么将无法修改**

#### 循环冗余检验CRC：
- 数据为<font color=#3399FF>k</font>个比特
- <font color=#3399FF>k</font>个比特后面加上<font color=#3399FF>n</font>个比特的供差错检验的冗余码

##### 冗余码的计算：
- 用<font color=#3399FF>k+n</font>个比特的数，使用模2计算的方式，除以事先确定好的除数<font color=#3399FF>P(一个n+1位的数据)</font>
- 每次得到一个余数<font color=#3399FF>R(一个n位的数据，比P少一位)</font>
- 注意<font color=#3399FF>k+n</font>的开头一定是1
- 最后将余数<font color=#3399FF>R</font>作为<font color=#FF0033>冗余码</font>，拼接在数据的后面
- P的选择由多项式决定，规则为：P的最高位和最低位必须为1，也就是说多项式一定有一个次数为P长度的项以及一个常数项，其他次数的项表示：次数对应P的位置上的数字是1
- 详细例子见计算机网络_2_链路层和局域网.ppt

##### 检验：
- 发送端从<font color=#3399FF>n</font>个0开始，CRC后得一个<font color=#3399FF>R</font>，拼接在数据的末尾
- 接收端利用末尾的<font color=#3399FF>n</font>位，CRC后得一个余数<font color=#3399FF>R</font>，<font color=#3399FF>R</font>为0，则接收数据；<font color=#3399FF>R</font>不为0，则丢弃数据

# 广播信道、信道复用

## 链路层不同的“链路”新式
1. 点对点：专享信道，采用PPP协议
2. 广播形式：共享线路或者传输媒介
 - 多接入协议：
  - 原因：广播信道中，往往只有一条共享的信道，然而有两个或多个结点，可能发生同时的数据传输，产生冲突
  - 分布式算法：每个节点上决定是否应该发送信号
  - 何时可以发送信号
  - 注意，所有的协议通信用到的也是该广播信道自身

## 三类多接入协议

### 信道划分

#### TDMA(时分复用)
- 每个节点在每一轮都会获得定长的`时隙slot(源自用户发送的数据)`
- 每个节点在一定的时间产生一个`帧(frame)`，每一个帧存放固定数量的`slot`，`slot`按顺序添加
- 如果在某个时间节点，某个主机没有发送数据，那么它的`slot`位置将空闲
- 即使有用户在持续发送数据，也不可以使用这些空隙，所以造成了很大的浪费

#### STDMA(统计时分复用)
- 使用<font color=#3399FF>集中器</font>，对TDMA进行改进
- 使用STDM帧来传送复用的数据，每个STDM帧的时隙数小于用户的数量
- 动态将数据添加进时隙，当一个帧满了就发送出去

#### FDMA(频分复用)
- 每个用户分配一个固定的频段
- 用户数量越大，所需的带宽就要越大

#### CDMA(码分复用)
- 将需要发送的信号通过不同的编码进行调制，然后复用广播信道

### 随机接入

#### Slotted ALOHA
- 基本假设：
 - 所有帧大小一致
 - 时间轴划分为等长的时隙，通常是传输一帧的时间
 - 节点均只在时隙开始的时候传输
 - 节点的行为是同步的
 - 如果超过两个节点在一个时隙同时传输，则所有节点能侦测到碰撞
- 操作
 - 当一个节点获得一个新的帧，则在下一个时隙开始的时候传输：
  - 如果没有碰撞，则传输成功，该节点成功传输了这个帧
  - 如果发生碰撞，则传输失败。该节点在以后的每一个时隙均以概率𝑝进行重传，直至传输成功
- 优点
 - 每个时隙中，都有一个节点可以一直以全速进行传输
 - 高度分布式算法：只需把所有节点的时隙进行同步即可，其余全部是通过节点自行探测解决
- 缺点
 - 碰撞，且浪费了很多时隙，也会有很多时隙是闲置的
 - 需要一个时隙去侦测碰撞的发生。但事实上节点可能只需要更少的时间就可以侦测碰撞
 - 需要时钟同步
- 效率
 - 设节点数N，每个节点在每个时隙成功发送的概率为p
 - 则“某个节点在某个时隙发送成功”的概率为：<font color=#3399FF>p(1-p)^(N-1)</font>
 - 则“任意结点在某个时隙发送成功”的概率为：<font color=#3399FF>p0=N*p(1-p)^(N-1)</font>
 - 求出，当<font color=#3399FF>p=1/N</font>时，p0有最大值<font color=#3399FF>p0=(1-1/N)^(N-1)</font>
 - 求Slotted ALOHA的最大效率，则对p0求极限（N->∞），极限为<font color=#3399FF>1/e</font>，即36.8%

#### CSMA(Carrier Sense Mutiple Access)协议家族
- 发送数据前先监听广播信道，如果信道空闲，则发送整个帧；如果信道正忙，则延迟发送

##### 碰撞检测
- “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。
- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
- 所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。
- 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
- 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。
- 最先发送数据帧的站，在发送数据帧后至多经过时间`2𝜏（两倍的端到端往返时延）`就可知道发送的数据帧是否遭受了碰撞。
- 以太网的端到端往返时延2𝜏称为<font color=#FF0033>争用期</font>，或<font color=#FF0033>碰撞窗口</font>。
- 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。
- 在10M bit/s的以太网中，传统取51.2𝜇𝑠为争用期的长度。对应在争用期内，可以发送512bit（64 byte）的数据
 - 即：若前64字节没有发生冲突，则该帧的后续数据不会发生冲突
 - 一半时间（25.6𝜇𝑠）对应着以太网的最大端到端的长度，约为5km（玻璃纤维中的信号传播速度约为200km/ms）

##### CSMA/CD算法
1. 网卡（NIC）从网络层收到数据报文，包装成帧
2. 如果NIC检测到信道空闲，则开始发送数据；反之，则等待直至信道空闲，然后发送数据
3. 如果网卡成功传输了整个帧，并没有遇到其他同时的传输，则该帧传输完成！
4. 如果NIC在发送帧的过程中检测到发生碰撞，则中止发送，并发送拥塞信号
5. 中止发送后，NIC进入二进制指数退避（binary exponential backoff）：
 - 基本退避时间为争用期2𝜏。
 - 若已经经过m次重传，则从整数集合{0,1,…,2^𝑚−1}中随机取出一个数，定为k。重传所需的时延即为k倍的争用期。
 - 重传16次仍不能成功，则丢弃该帧，并向更高层次的协议报告。
 - Truncated binary exponential backoff：经过m次重传后，整数集合选定为{0,1,…,2^(𝑚^′ )−1}, 𝑚^′=min⁡{𝑚, 10}.

### 受控接入

#### 轮询(polling)
- 主节点(master)邀请次节点(slave)轮流发送数据

#### 令牌传递(token passing)
- 受控的令牌从一个节点依次序传递到下一个节点
- 有令牌的节点即可发送帧

# 链路层寻址

## MAC(Media Access Control)地址
- 48位，通常都烧录进NIC的ROM中，有时候也可以通过软件设定
- 注意：并不是一台电脑或者一台路由器/交换机只有一个MAC地址，MAC地址是和端口绑定的
- 前24位(3字节)——组织唯一标识符
- 后24位(3字节)——扩展唯一标识符

- 适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址。
 - 如果是发往本站的帧则收下，然后再进行其他的处理。
 - 否则就将此帧丢弃，不再进行其他的处理。

- “发往本站的帧”包括以下三种帧： 
 - 单播 (unicast) 帧（一对一）
 - 广播 (broadcast) 帧（一对全体）
 - 多播 (multicast) 帧（一对多）

## NIC检查MAC地址
- 所有的适配器都至少能够识别前两种帧，即能够识别单播地址和广播地址。
- 有的适配器可用编程方法识别多播地址。
- 只有目的地址才能使用广播地址和多播地址。
- 以混杂方式 (promiscuous mode) 工作的以太网适配器只要“听到”有帧在以太网上传输就都接收下来。

## ARP(Adress Resolution Protocal)协议
- ARP表：局域网中的每个节点（主机、路由器等）都有一张表，称之为ARP表。
 - 存储了局域网中某些节点的IP地址/MAC地址的映射关系。
 - IP address; MAC address; TTL
 - TTL (time to live): 多久之后忘记该映射（典型值：20分钟）。

## ARP协议——同一局域网内
- A需要发送数据报给B
 - 假设A的ARP表中并没有B的MAC地址
 - 虽然A知道B的IP地址，在网络层A知道B的位置，但是链路层A并不知道
- A发送广播ARP查询packet，包含了B的IP地址
 - 该packet中的目的MAC地址是FF-FF-FF-FF-FF-FF（广播）
 - 局域网中所有节点都收到了该查询
- B收到该packet，将自身的MAC地址回复给A
 - 这个回复帧，发送给A的MAC地址（单播）
- A将学习到的IP-MAC地址映射存放在其ARP表中，直到该信息过时：
 - 除非更新信息，否则在TTL后该信息即为过时
- ARP协议是“即插即用”的：
 - 节点创建自己的ARP表格，并不需要网络管理员的人工干涉

## ARP协议——不在同一局域网内
- 过程基本相同，但需要分开先从边缘路由器跳转，获得各自的MAC地址